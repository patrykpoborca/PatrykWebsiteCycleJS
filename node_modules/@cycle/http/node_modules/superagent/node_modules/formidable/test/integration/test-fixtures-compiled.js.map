{"version":3,"sources":["test-fixtures.js"],"names":[],"mappings":";;AAAA,IAAI,OAAO,GAAG,OAAO,CAAC,SAAS,CAAC,CAAC;AACjC,IAAI,EAAE,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC;AACvB,IAAI,MAAM,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC;AAC/B,IAAI,IAAI,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC;AAC3B,IAAI,IAAI,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC;AAC3B,IAAI,GAAG,GAAG,OAAO,CAAC,KAAK,CAAC,CAAC;AACzB,IAAI,MAAM,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC;;AAE/B,IAAI,MAAM,GAAG,OAAO,CAAC,WAAW,CAAC,CAAC;AAClC,IAAI,UAAU,GAAG,MAAM,CAAC,UAAU,CAAC;;AAEnC,IAAI,MAAM,GAAG,IAAI,CAAC,YAAY,EAAE,CAAC;AACjC,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,YAAY,CAAC,CAAC;;AAEzC,SAAS,YAAY,GAAG;AACtB,MAAI,QAAQ,GAAG,EAAE,CAAC;AAClB,QAAM,CACH,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,OAAO,GAAG,KAAK,CAAC,CAChC,OAAO,CAAC,UAAS,MAAM,EAAE;AACxB,QAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,OAAO;;AAElC,QAAI,KAAK,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;AACzC,WAAO,CAAC,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,UAAS,OAAO,EAAE,IAAI,EAAE;AACvD,cAAQ,CAAC,IAAI,CAAC;AACZ,YAAI,EAAM,KAAK,GAAG,GAAG,GAAG,IAAI;AAC5B,eAAO,EAAG,OAAO;OAClB,CAAC,CAAC;KACJ,CAAC,CAAC;GACJ,CAAC,CAAC;;AAEL,UAAQ,CAAC,QAAQ,CAAC,CAAC;CACpB;;AAED,SAAS,QAAQ,CAAC,QAAQ,EAAE;AAC1B,MAAI,OAAO,GAAG,QAAQ,CAAC,KAAK,EAAE,CAAC;AAC/B,MAAI,CAAC,OAAO,EAAE,OAAO,MAAM,CAAC,KAAK,EAAE,CAAC;;AAEpC,MAAI,IAAI,GAAM,OAAO,CAAC,IAAI,CAAC;AAC3B,MAAI,OAAO,GAAG,OAAO,CAAC,OAAO,CAAC;;AAE9B,eAAa,CAAC,IAAI,EAAE,UAAS,GAAG,EAAE,KAAK,EAAE;AACvC,QAAI,GAAG,EAAE,MAAM,GAAG,CAAC;;AAEnB,WAAO,CAAC,OAAO,CAAC,UAAS,YAAY,EAAE,CAAC,EAAE;AACxC,UAAI,UAAU,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC;AAC1B,YAAM,CAAC,KAAK,CAAC,UAAU,CAAC,IAAI,EAAE,YAAY,CAAC,IAAI,CAAC,CAAC;AACjD,YAAM,CAAC,KAAK,CAAC,UAAU,CAAC,IAAI,EAAE,YAAY,CAAC,IAAI,CAAC,CAAC;;AAEjD,UAAI,UAAU,CAAC,IAAI,KAAK,MAAM,EAAE;AAC9B,YAAI,IAAI,GAAG,UAAU,CAAC,KAAK,CAAC;AAC5B,cAAM,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,EAAE,YAAY,CAAC,QAAQ,CAAC,CAAC;AAC/C,YAAG,YAAY,CAAC,IAAI,EAAE,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,EAAE,YAAY,CAAC,IAAI,CAAC,CAAC;OAClE;KACF,CAAC,CAAC;;AAEH,YAAQ,CAAC,QAAQ,CAAC,CAAC;GACpB,CAAC,CAAC;CACJ,CAAC;;AAEF,SAAS,aAAa,CAAC,IAAI,EAAE,EAAE,EAAE;AAC/B,QAAM,CAAC,IAAI,CAAC,SAAS,EAAE,UAAS,GAAG,EAAE,GAAG,EAAE;AACxC,QAAI,IAAI,GAAG,IAAI,UAAU,CAAC,YAAY,EAAE,CAAC;AACzC,QAAI,CAAC,SAAS,GAAG,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC;AAChC,QAAI,CAAC,IAAI,GAAG,MAAM,CAAC;AACnB,QAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;;AAEhB,aAAS,QAAQ,GAAG;AAClB,UAAI,YAAY,GAAG,EAAE,CAAC;AACtB,QAAE,GAAG,YAAW,EAAE,CAAC;AACnB,kBAAY,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;KACrC;;AAED,QAAI,KAAK,GAAG,EAAE,CAAC;AACf,QAAI,CACD,EAAE,CAAC,OAAO,EAAE,QAAQ,CAAC,CACrB,EAAE,CAAC,WAAW,EAAE,UAAS,IAAI,EAAE,KAAK,EAAE;AACrC,WAAK,CAAC,IAAI,CAAC,EAAC,IAAI,EAAE,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK,EAAC,CAAC,CAAC;KACtD,CAAC,CACD,EAAE,CAAC,OAAO,EAAE,UAAS,IAAI,EAAE,KAAK,EAAE;AACjC,WAAK,CAAC,IAAI,CAAC,EAAC,IAAI,EAAE,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK,EAAC,CAAC,CAAC;KACvD,CAAC,CACD,EAAE,CAAC,KAAK,EAAE,YAAW;AACpB,SAAG,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;AACd,cAAQ,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;KACvB,CAAC,CAAC;GACN,CAAC,CAAC;;AAEH,MAAI,MAAM,GAAG,GAAG,CAAC,gBAAgB,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;AAC/C,MAAI,IAAI,GAAG,EAAE,CAAC,gBAAgB,CAAC,MAAM,CAAC,GAAG,CAAC,OAAO,GAAG,QAAQ,GAAG,IAAI,CAAC,CAAC;;AAErE,MAAI,CAAC,IAAI,CAAC,MAAM,EAAE,EAAC,GAAG,EAAE,KAAK,EAAC,CAAC,CAAC;AAChC,QAAM,CAAC,EAAE,CAAC,MAAM,EAAE,YAAY;AAC5B,UAAM,CAAC,GAAG,EAAE,CAAC;GACd,CAAC,CAAC;CAEJ","file":"test-fixtures-compiled.js","sourcesContent":["var hashish = require('hashish');\nvar fs = require('fs');\nvar findit = require('findit');\nvar path = require('path');\nvar http = require('http');\nvar net = require('net');\nvar assert = require('assert');\n\nvar common = require('../common');\nvar formidable = common.formidable;\n\nvar server = http.createServer();\nserver.listen(common.port, findFixtures);\n\nfunction findFixtures() {\n  var fixtures = [];\n  findit\n    .sync(common.dir.fixture + '/js')\n    .forEach(function(jsPath) {\n      if (!/\\.js$/.test(jsPath)) return;\n\n      var group = path.basename(jsPath, '.js');\n      hashish.forEach(require(jsPath), function(fixture, name) {\n        fixtures.push({\n          name    : group + '/' + name,\n          fixture : fixture,\n        });\n      });\n    });\n\n  testNext(fixtures);\n}\n\nfunction testNext(fixtures) {\n  var fixture = fixtures.shift();\n  if (!fixture) return server.close();\n\n  var name    = fixture.name;\n  var fixture = fixture.fixture;\n\n  uploadFixture(name, function(err, parts) {\n    if (err) throw err;\n\n    fixture.forEach(function(expectedPart, i) {\n      var parsedPart = parts[i];\n      assert.equal(parsedPart.type, expectedPart.type);\n      assert.equal(parsedPart.name, expectedPart.name);\n\n      if (parsedPart.type === 'file') {\n        var file = parsedPart.value;\n        assert.equal(file.name, expectedPart.filename);\n        if(expectedPart.sha1) assert.equal(file.hash, expectedPart.sha1);\n      }\n    });\n\n    testNext(fixtures);\n  });\n};\n\nfunction uploadFixture(name, cb) {\n  server.once('request', function(req, res) {\n    var form = new formidable.IncomingForm();\n    form.uploadDir = common.dir.tmp;\n    form.hash = \"sha1\";\n    form.parse(req);\n\n    function callback() {\n      var realCallback = cb;\n      cb = function() {};\n      realCallback.apply(null, arguments);\n    }\n\n    var parts = [];\n    form\n      .on('error', callback)\n      .on('fileBegin', function(name, value) {\n        parts.push({type: 'file', name: name, value: value});\n      })\n      .on('field', function(name, value) {\n        parts.push({type: 'field', name: name, value: value});\n      })\n      .on('end', function() {\n        res.end('OK');\n        callback(null, parts);\n      });\n  });\n\n  var socket = net.createConnection(common.port);\n  var file = fs.createReadStream(common.dir.fixture + '/http/' + name);\n\n  file.pipe(socket, {end: false});\n  socket.on('data', function () {\n    socket.end();\n  });\n\n}\n"]}